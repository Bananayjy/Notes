## 十、日志模块

### 一、前言

#### 1、概述

Mybatis的日志模块内容，主要位于logging包下

![image-20250329220704695](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250329220704695.png)

> 无论在开发测试环境中，还是在线上生产环境中，日志在整个系统中的地位都是非常重要的。良好的日志功能可以帮助开发人员和测试人员快速定位 Bug 代码，也可以帮助运维人员快速定位性能瓶颈等问题。目前的 Java 世界中存在很多优秀的日志框架，例如 Log4j、 Log4j2、Slf4j 等。
>
> MyBatis 作为一个设计优良的框架，除了提供详细的日志输出信息，还要能够集成多种日志框架，其日志模块的一个主要功能就是**集成第三方日志框架**。

org.apache.ibatis.logging.Log接口相关结构图如下所示：

![image-20250329221436611](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250329221436611.png)

可以看到非常多的 Logger 类的实现，分别对应我们常用的日志框架 Log4j、Slf4j ，这就是 MyBatis 对这些日志框架的适配

![image-20250329221658401](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250329221658401.png)

BaseJdbcLogger 以及其四个子类，是 MyBatis 通过 JDK 动态代理的方式，将 JDBC 的操作，打印到日志中



### 二、相关内容

#### 1、 LogFactory

该类位于`org.apache.ibatis.logging`包下，是Log的工厂类

##### 1.成员变量

```java
/**
 * Marker to be used by logging implementations that support markers.
 */
public static final String MARKER = "MYBATIS";

// 锁
private static final ReentrantLock lock = new ReentrantLock();

// 使用的 Log 的构造方法
private static Constructor<? extends Log> logConstructor;
```

##### 2. 构造器

私有构造器，不对外开发创建实例

```java
private LogFactory() {
    // disable construction
}
```

##### 3.静态代码块

```java
// 通过静态代码块逐个尝试，判断使用哪个 Log 的实现类，即初始化 logConstructor 属性
// 按照 Slf4j、CommonsLogging、Log4J2Logging、Log4JLogging、JdkLogging、NoLogging 的顺序，逐个尝试
static {
    tryImplementation(LogFactory::useSlf4jLogging);
    tryImplementation(LogFactory::useCommonsLogging);
    tryImplementation(LogFactory::useLog4J2Logging);
    tryImplementation(LogFactory::useLog4JLogging);
    tryImplementation(LogFactory::useJdkLogging);
    tryImplementation(LogFactory::useNoLogging);
}
```

通过tryImplementation判断使用哪个Log的实现类，其中入参Runnable是函数式接口,使用了 Lambda 表达式声明调用的方法

```java
private static void tryImplementation(Runnable runnable) {
    if (logConstructor == null) {
        try {
            runnable.run();
        } catch (Throwable t) {
            // ignore
        }
    }
}
```

如`tryImplementation(LogFactory::useSlf4jLogging);`，当runnable调用run方法的时候，就会调用LogFactory的useSlf4jLogging方法，该方法内容如下所示

```java
public static void useSlf4jLogging() {
    setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);
}

private static void setImplementation(Class<? extends Log> implClass) {
    // 加锁
    lock.lock();
    try {
        // 获得implClass的参数为 String 的构造方法
        Constructor<? extends Log> candidate = implClass.getConstructor(String.class);
        // 创建 Log 对象
        Log log = candidate.newInstance(LogFactory.class.getName());
        // 日志打印debug日志是否开启
        if (log.isDebugEnabled()) {
            log.debug("Logging initialized using '" + implClass + "' adapter.");
        }
        // 创建成功，意味着可以使用，设置为 logConstructor
        logConstructor = candidate;
    } catch (Throwable t) {
        throw new LogException("Error setting Log implementation.  Cause: " + t, t);
    } finally {
        // 释放锁
        lock.unlock();
    }
}
```

CommonsLogging、Log4J2Logging、Log4JLogging、JdkLogging、NoLogging为使用的 Log 的构造方法logConstructor赋值的方法都是类似的。

同样，也可以通过调用useCustomLogging方法设置自定义的 Log 实现类

```java
public static void useCustomLogging(Class<? extends Log> clazz) {
    setImplementation(clazz);
}
```

##### 4.getLog方法

获得 Log 对象

```java
public static Log getLog(Class<?> clazz) {
    return getLog(clazz.getName());
}

public static Log getLog(String logger) {
    try {
        return logConstructor.newInstance(logger);
    } catch (Throwable t) {
        throw new LogException("Error creating logger for logger " + logger + ".  Cause: " + t, t);
    }
}
```



#### 2、Log

##### 1.Log接口

其位于`org.apache.ibatis.logging`包下，是Mybatis Log接口，相关内容如下所示

```java
public interface Log {

    // 是否开启Debug日志
    boolean isDebugEnabled();

    // 是否开启Trace日志
    boolean isTraceEnabled();

    // error日志
    void error(String s, Throwable e);

    // error日志
    void error(String s);

    // debug日志
    void debug(String s);

    // trace日志
    void trace(String s);

    // warn日志
    void warn(String s);

}
```

Log 的实现类较多，如下所示：

![image-20250329221436611](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250329221436611.png)

##### 2.StdOutImpl

其实Log最简单的实现类，即将日志通过System输出到控制台中即可，其源码如下所示：



#### 3、BaseJdbcLogger

其位于`org.apache.ibatis.logging.jdbc`包下，相关结构如下图所示

![image-20250329221658401](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250329221658401.png)

BaseJdbcLogger 以及其四个子类，是 MyBatis 通过 JDK 动态代理的方式，在对应JDBC 的操作前后，通过其中维护的Log实现类，打印相关日志。



### 三、测试

#### 1、LogFactoryTest

测试通过LogFactory获取不同的Log实现类，并进行日志的打印测试，相关源码如下所示：

```java
class LogFactoryTest {

    //  当前测试类的所有测试方法执行完毕后运行一次
    @AfterAll
    static void restore() {
        LogFactory.useSlf4jLogging();
    }

    @Test
    void shouldUseCommonsLogging() {
        LogFactory.useCommonsLogging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), JakartaCommonsLoggingImpl.class.getName());
    }

    @Test
    void shouldUseLog4J() {
        LogFactory.useLog4JLogging();
        Log log = LogFactory.getLog(Object.class);
        System.out.println(log.isDebugEnabled());
        logSomething(log);
        assertEquals(log.getClass().getName(), Log4jImpl.class.getName());
    }

    @Test
    void shouldUseLog4J2() {
        LogFactory.useLog4J2Logging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), Log4j2Impl.class.getName());
    }

    @Test
    void shouldUseJdKLogging() {
        LogFactory.useJdkLogging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), Jdk14LoggingImpl.class.getName());
    }

    @Test
    void shouldUseSlf4j() {
        LogFactory.useSlf4jLogging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), Slf4jImpl.class.getName());
    }

    @Test
    void shouldUseStdOut() {
        LogFactory.useStdOutLogging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), StdOutImpl.class.getName());
    }

    @Test
    void shouldUseNoLogging() {
        LogFactory.useNoLogging();
        Log log = LogFactory.getLog(Object.class);
        logSomething(log);
        assertEquals(log.getClass().getName(), NoLoggingImpl.class.getName());
    }

    @Test
    void shouldReadLogImplFromSettings() throws Exception {
        try (Reader reader = Resources.getResourceAsReader("org/apache/ibatis/logging/mybatis-config.xml")) {
            new SqlSessionFactoryBuilder().build(reader);
        }

        Log log = LogFactory.getLog(Object.class);
        log.debug("Debug message.");
        assertEquals(log.getClass().getName(), NoLoggingImpl.class.getName());
    }

    private void logSomething(Log log) {
        log.warn("Warning message.");
        log.debug("Debug message.");
        log.error("Error message.");
        log.error("Error with Exception.", new Exception("Test exception."));
    }

}
```

#### 2、BaseJdbcLoggerTest

![image-20250330143422412](%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.assets/image-20250330143422412.png)