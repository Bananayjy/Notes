# 2024-06-24

## 一、通过Optional进行判空的写法

### 1.1 老写法

```java
if(CollectionUtil.isNotEmpty(userDto.getDeptIds())){
	userDto.getDeptIds().stream().map(deptId -> {
        SysUserDept userDept = new SysUserDept();
        userDept.setUserId(sysUser.getUserId());
        userDept.setDeptId(deptId);
        return userDept;
    }).forEach(sysUserDeptMapper::insert);
}
```



### 1.2 使用Optional写法

```java
// 保存用户部门对应关系
Optional.ofNullable(userDto.getDeptIds()).ifPresent(depts -> {
    depts.stream().map(deptId -> {
        SysUserDept userDept = new SysUserDept();
        userDept.setUserId(sysUser.getUserId());
        userDept.setDeptId(deptId);
        return userDept;
    }).forEach(sysUserDeptMapper::insert);
});
```



### 1.3 初步解析

#### 1、ofNullable

```java
/**
 * 如果指定的值非空，则返回描述该值的Optional对象，否则返回一个空的Optional对象
 * Returns an {@code Optional} describing the specified value, if non-null,
 * otherwise returns an empty {@code Optional}.
 *
 * @param <T> the class of the value
 * @param value the possibly-null value to describe
 * @return an {@code Optional} with a present value if the specified value
 * is non-null, otherwise an empty {@code Optional}
 */
public static <T> Optional<T> ofNullable(T value) {
    return value == null ? empty() : of(value);
}
```

获得返回一个包含指定的非空值的{@code Optional}对象

```java
 /**
 * Returns an {@code Optional} with the specified present non-null value. 返回一个包含指定的非空值的{@code Optional}对象
 *
 * @param <T> the class of the value
 * @param value the value to be present, which must be non-null
 * @return an {@code Optional} with the value present
 * @throws NullPointerException if value is null
 */
public static <T> Optional<T> of(T value) {
    return new Optional<>(value);
}
```

返回Optional中维护的EMPTY的值

```java
public static<T> Optional<T> empty() {
    // 通过@SuppressWarnings("unchecked")注解，可以告诉编译器不要产生这些警告信息。这个注解应该谨慎使用，因为它会关闭编译器对可能存在的类型安全问题的警告。
    @SuppressWarnings("unchecked")
    Optional<T> t = (Optional<T>) EMPTY;
    return t;
}
```

EMPTY的值为无参的Optional构造器创建的实例对象

```java
private static final Optional<?> EMPTY = new Optional<>();
```

Optional的无参构造器，将Optional类中维护的value值置为null

```java
/**
 * Constructs an empty instance.
 *
 * @implNote Generally only one empty instance, {@link Optional#EMPTY},
 * should exist per VM.
 */
private Optional() {
    this.value = null;
}
```



#### 2、ifPresent

```java
/**
 * 如果存在数值，使用指定的消费者处理该数值，否则不执行任何操作000
 * If a value is present, invoke the specified consumer with the value,
 * otherwise do nothing.
 *
 * @param consumer block to be executed if a value is present
 * @throws NullPointerException if value is present and {@code consumer} is
 * null
 */
public void ifPresent(Consumer<? super T> consumer) {
    if (value != null)
        consumer.accept(value);
}
```



## 二、关于MySQL中JSON字段和text存储的大小

- MySQL 5.7 及更高版本支持的 JSON 列的最大存储大小是 1 GB（1,073,741,824 字节）

- `TEXT` 数据类型用于存储大文本数据。不同的 `TEXT` 类型（包括 `TINYTEXT`, `TEXT`, `MEDIUMTEXT`, `LONGTEXT`）能够存储的最大字符数各不相同。
  - **`TINYTEXT`**：最大长度：255 字节
  - **`TEXT`**：最大长度：65,535 字节（约 64 KB）
  - **`MEDIUMTEXT`**：最大长度：16,777,215 字节（约 16 MB）
  - **`LONGTEXT`**：最大长度：4,294,967,295 字节（约 4 GB）



注意：**行大小限制**：MySQL InnoDB 存储引擎对单行的存储大小有限制，最大行大小是 65,535 字节。这包括 JSON 列以及其他列的数据。如果 JSON 列与其他列的数据一起超过了最大行大小限制，可能会导致错误。