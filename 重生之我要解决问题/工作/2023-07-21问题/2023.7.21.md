# 2023.7.21

## 1、获取第三方应用授权企业的accessToken

？？？



#### 2、 获取舟山口腔货物采购单的审核表单模板

PROC-676991C2-F0F9-48AD-9171-7D4878617AAD



可以用该编码发起审核实例









获取钉钉审批流结点信息方法

```java
/**
     * 获取钉钉审批流节点信息
     */
public ProcessNodeInfoOutput getProcessNodeInfo(ProcessNodeInfoInput input){
    String url = sysParametersRepository.selectValueByCode(0L, ParameterConstants.DING_GET_PROCESS_NODE_URL);
    input.setProcess_code(sysParametersRepository.selectValueByCode(0L, ParameterConstants.PROCESS_CODE_EYHT));
    input.setSign(sysParametersRepository.selectValueByCode(0L, ParameterConstants.OA_SIGN));
    String requestBody = JSON.toJSONString(input);
    String resp = OkHttpUtil.postJsonParams(url, requestBody);

    logger.info("获取钉钉审批流节点信息，发送请求body:{}", requestBody);
    logger.info("获取钉钉审批流节点信息，返回结果:{}", resp);
    if (org.springframework.util.StringUtils.isEmpty(resp)) {
        logger.error("获取钉钉审批流实例,调用失败");
    }
    JsonData response = JSONObject.toJavaObject(JSON.parseObject(resp), JsonData.class);
    if (!response.getSuccess()) {
        logger.error("获取钉钉审批流节点信息 返回false,msg:" + response.getMsg());
        return null;
    } else {
        JSONObject data = JSON.parseObject(response.getData().toString());
        return data.toJavaObject(ProcessNodeInfoOutput.class);
    }
}



/**
         * 钉钉获取审批流节点信息
         */
String DING_GET_PROCESS_NODE_URL = "ding_get_process_node_url";
```

钉钉获取审批流结点请求地址：

http://dev.yy.kinglinksoft.com:14084/workapi3/ding/process/node





入参信息：

```java
package com.nbnfsoft.contract.domain.input;

import io.swagger.annotations.ApiModelProperty;

import java.util.List;

public class ProcessNodeInfoInput extends NFKJSignDto{
    @ApiModelProperty(value = "发起人所在的部门(发起人属于根部门，传-1)")
    private Long dept_id;

    @ApiModelProperty(value = "审批流表单参数")
    private List<FormComponent> form_component_values;

    @ApiModelProperty(value = "机构")
    private Long org_id;

    @ApiModelProperty(value = "发起审批单的员工userId值")
    private String originator_user_id;


    @ApiModelProperty(value = "表单的唯一码")
    private String process_code;

    public Long getDept_id() {
        return dept_id;
    }

    public void setDept_id(Long dept_id) {
        this.dept_id = dept_id;
    }

    public List<FormComponent> getForm_component_values() {
        return form_component_values;
    }

    public void setForm_component_values(List<FormComponent> form_component_values) {
        this.form_component_values = form_component_values;
    }

    public Long getOrg_id() {
        return org_id;
    }

    public void setOrg_id(Long org_id) {
        this.org_id = org_id;
    }

    public String getOriginator_user_id() {
        return originator_user_id;
    }

    public void setOriginator_user_id(String originator_user_id) {
        this.originator_user_id = originator_user_id;
    }



    public String getProcess_code() {
        return process_code;
    }

    public void setProcess_code(String process_code) {
        this.process_code = process_code;
    }
}

```









补全信息

```java
 //只获取到已完成的节点数据 调用work 补全
        if (ObjectUtil.isNotEmpty(processInstance)) {
            //获取节点信息
            ProcessNodeInfoInput nodeInput = new ProcessNodeInfoInput();
            nodeInput.setDept_id(Long.parseLong(processInstance.getOriginator_dept_id()));
            nodeInput.setOrg_id(contInfo.getOrgId());
            nodeInput.setOriginator_user_id(processInstance.getOriginator_dept_id());
            for(FormComponent fc: processInstance.getForm_component_values()) {
                if(org.apache.commons.lang3.StringUtils.isNotEmpty(fc.getName())) {
                    nodeInput.setForm_component_values(Collections.singletonList(fc));
                    break;
                }
            }
            //待执行的审批
            List<ProcessInstanceOperationRecordOutput> processWaitList = new ArrayList<>();
            //获取任务对应节点名
            Map<String, String> userNodeNameMap = new HashMap<>();
            List<ProcessInstanceTaskOutput> processTasks = processInstance.getTasks();
            ProcessNodeInfoOutput processNodes = dingManager.getProcessNodeInfo(nodeInput);
            if(processNodes != null && processNodes.getWorkflow_activity_rules() != null) {
                for(ProcessInstanceTaskOutput taskOutput:processTasks) {
                    if (!taskOutput.getUserid().matches("^\\d+$")) {
                        continue;
                    }
                    if(taskOutput.getActivity_id() != null) {
                        processNodes.getWorkflow_activity_rules().stream()
                                .filter(r -> taskOutput.getActivity_id().equals(r.getActivity_id())).findFirst().ifPresent(workFlow -> taskOutput.setActivity_name(workFlow.getActivity_name()));
                    }
                    DicEmployee employee = dicEmployeeRepository.selectOne(new LambdaQueryWrapper<DicEmployee>()
                            .eq(DicEmployee::getDdUserid, taskOutput.getUserid())
                            .eq(DicEmployee::getDeleted, YNEnum.NO.getCode()));
                    if(employee == null) {
                        continue;
                    }
                    if(taskOutput.getTaskStatus().equals("RUNNING") && taskOutput.getTaskResult().equals("NONE")) {
                        ProcessInstanceOperationRecordOutput recordOutput = new ProcessInstanceOperationRecordOutput();
                        recordOutput.setUser_name(employee.getEmpName());
                        recordOutput.setUser_photo(employee.getPhoto());
                        recordOutput.setUserid(employee.getId().toString());
                        recordOutput.setDdUserid(taskOutput.getUserid());
                        recordOutput.setNode_name(taskOutput.getActivity_name());
                        processWaitList.add(recordOutput);
                    } else {
                        userNodeNameMap.put(String.valueOf(employee.getId()), taskOutput.getActivity_name());
                    }
                }
            }

            List<ProcessInstanceOperationRecordOutput> operationRecords = processInstance.getOperation_records();
            operationRecords.addAll(processWaitList);
            processInstance.setOperation_records(operationRecords);
            String esignUrl = sysParametersRepository.selectValueByCode(0L, ParameterConstants.ESIGN_URL);
            //审批节点
            operationRecords.stream().filter(e -> "AGREE".equals(e.getResult()) || "REFUSE".equals(e.getResult()))
                    .forEach(record -> {
                        try {
                            //调用系统电子签名
                            Map<String, String> paramMap = new HashMap<>();
                            paramMap.put("emp_id", record.getUserid());
                            String token = SecurityUtils.getLoginUser().getToken();
                            String resp = OkHttpUtil.get(esignUrl + WorkApiUri.ESIGN_REQUEST_URL, paramMap, Constants.AUTHORIZATION, token);
                            logger.info("获取签名，发送请求body:{}", paramMap);
                            logger.info("获取签名，返回结果:{}", resp);
                            if (ObjectUtil.isEmpty(resp)) {
                                logger.error("获取工号为" + record.getUserid() + "的签名失败");
                            }
                            JsonData jsonData = JSONObject.toJavaObject(JSON.parseObject(resp), JsonData.class);

                            if (!jsonData.getSuccess()) {
                                logger.error("获取签名，返回false，msg：" + jsonData.getMsg());
                            }
                            JSONObject data = JSON.parseObject(jsonData.getData().toString());
                            List<EsignDetailOutput> signList = JSON.parseArray(data.get("list").toString(), EsignDetailOutput.class);

                            String img = signList.get(0).getImg();
                            logger.info("签名图片路劲" + img);

                            record.setUser_sign(img);
                            record.setNode_name(userNodeNameMap.get(record.getUserid()));
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    });
        }

        ContractDetailContentDto detail = new ContractDetailContentDto();
        detail.setId(contInfo.getId());
        detail.setPurchaseDept(IdNameDto.getFirstOne(dicDeptRepository.getDeptsByIds(Convert.toStr(contInfo.getPurchaseDept()))));
        detail.setUseDept(IdNameDto.getFirstOne(dicDeptRepository.getDeptsByIds(Convert.toStr(contInfo.getUseDept()))));
        detail.setPurchaseDate(contInfo.getPurchaseDate());
        detail.setPurchaseEmp(dicEmployeeRepository.getEmpsByIds(contInfo.getPurchaseEmp()));
        detail.setName(contInfo.getName());
        detail.setCode(contInfo.getCode());
        detail.setCategory(sysCategoryRepository.getOneById(contInfo.getType()));
        detail.setPurchaseType(contInfo.getPurchaseType());
        detail.setProperty(contInfo.getProperty());
        detail.setBudgetProperty(contInfo.getBudgetProperty());
        detail.setIsRenew(contInfo.getIsRenew());
        detail.setIsFixed(contInfo.getIsFixed());
        detail.setIsPurchase(contInfo.getIsPurchase());
        detail.setPrice(contInfo.getPrice());
        detail.setEndDate(contInfo.getEndDate());
        detail.setSupplier(contSupplierRepository.getByIds(contInfo.getSupplier()));
        detail.setPayItem(contPayItemRepository.getPayItemsByContId(contInfo.getId()));
        detail.setAttachCont(sysAttachmentManager.getByHost(AttachHostTypeEnum.HT_HTFJ.getCode(), contInfo.getId()));
        detail.setAttachCgd(sysAttachmentManager.getByHost(AttachHostTypeEnum.HT_CGD.getCode(), contInfo.getId()));
        detail.setAttachOther(sysAttachmentManager.getByHost(AttachHostTypeEnum.HT_OTHER.getCode(), contInfo.getId()));
        detail.setEmpName(dicEmployeeRepository.getEmpById(Convert.toStr(contInfo.getCreateId())).getName());
        detail.setDeptName(dicDeptRepository.getDeptNameById(contInfo.getDeptId()));
        detail.setDeptId(contInfo.getDeptId());
        if (!CollectionUtils.isEmpty(detail.getPayItem())) {
            detail.getPayItem().forEach(p -> {
                p.setRemindEmp(dicEmployeeRepository.getEmpsByIds(p.getRemindEmpIds()));
            });
        }
        detail.setExpertName(contInfo.getExpertName());
        detail.setMonitorUsers(dicEmployeeRepository.getEmpsByIds(contInfo.getMonitorUser()));
        result.setSignStatus(contInfo.getSignStatus());
        result.setContent(detail);
        //redis增加已读标记
        if ("refuse".equals(contInfo.getResult())) {
            redisTemplate.boundSetOps(Constants.CONTRACT_REFUSED + contInfo.getId()).add(SecurityUtils.getUserId());
        }
        return result;
```













## 问题：

```java
 for(FormComponent fc: processInstanceOutput.getForm_component_values()){
     if(org.apache.commons.lang3.StringUtils.isNotEmpty(fc.getName())){
         nodeInput.setForm_component_values(Collections.singletonList(fc));
         break;
     }
 }
```

